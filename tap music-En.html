<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MusicTap Clone (Canvas + WebAudio)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background-color: #1a1a1a;
            overflow: hidden;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }
        canvas { display: block; }
        
        /* Start Screen Overlay */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(57, 197, 187, 0.9); /* Miku Green */
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100; cursor: pointer;
            transition: opacity 0.5s;
        }
        #overlay.hidden { opacity: 0; pointer-events: none; }
        h1 { font-size: 40px; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase; }
        p { font-size: 16px; opacity: 0.8; margin-top: 10px; }
        .blink { animation: blink 1.5s infinite; }
        
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>GEOMETRY TAP</h1>
        <p class="blink">CLICK SCREEN OR PRESS ANY KEY TO START</p>
    </div>

    <canvas id="canvas"></canvas>

<script>
/**
 * Core Logic:
 * 1. AudioEngine: Handles sound synthesis via Web Audio API.
 * 2. VisualEngine: Handles Canvas animation and drawing.
 * 3. Interaction: Handles Keyboard and Mouse/Touch events.
 */

// --- 1. Audio Engine ---
const AudioEngine = {
    ctx: null,
    isPlaying: false,
    tempo: 120,
    nextNoteTime: 0,
    beatCount: 0,
    
    // Pentatonic Scale (C4, D4, E4, G4, A4...)
    // This scale ensures that random notes sound harmonious together.
    scale: [261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33, 659.25, 783.99, 880.00],

    init() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
        this.scheduler();
    },

    resume() {
        if (this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
        if (!this.isPlaying) {
            this.isPlaying = true;
            this.nextNoteTime = this.ctx.currentTime + 0.1;
        }
    },

    // Play a single synthesized tone
    playTone(index) {
        if (!this.ctx) return;
        
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        // Randomize wave type for variety
        osc.type = Math.random() > 0.5 ? 'triangle' : 'sine';
        
        // Select frequency from scale, or random if index not provided
        const freq = index !== undefined 
            ? this.scale[index % this.scale.length] 
            : this.scale[Math.floor(Math.random() * this.scale.length)];
            
        osc.frequency.value = freq;
        
        // Envelope: Fast attack, fast decay (percussive sound)
        const t = this.ctx.currentTime;
        gain.gain.setValueAtTime(0, t);
        gain.gain.linearRampToValueAtTime(0.3, t + 0.02); // Attack
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5); // Decay
        
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start(t);
        osc.stop(t + 0.5);
    },

    // Simple Background Drum Beat (Kick & Hi-hat)
    playDrum(type, time) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);

        if (type === 'kick') {
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
            gain.gain.setValueAtTime(0.5, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
            osc.start(time);
            osc.stop(time + 0.5);
        } else if (type === 'hat') {
            // Using high frequency square wave to simulate hi-hat noise
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, time); 
            osc.frequency.linearRampToValueAtTime(10000, time + 0.05);
            
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
            osc.start(time);
            osc.stop(time + 0.05);
        }
    },

    // Rhythm Scheduler
    scheduler() {
        if (!this.isPlaying) {
            requestAnimationFrame(() => this.scheduler());
            return;
        }

        const secondsPerBeat = 60.0 / this.tempo;
        const lookahead = 0.1; // 100ms

        while (this.nextNoteTime < this.ctx.currentTime + lookahead) {
            // 4/4 Time Signature
            if (this.beatCount % 4 === 0) {
                this.playDrum('kick', this.nextNoteTime);
                VisualEngine.flashBackground(); // Sync visual flash with kick
            } else {
                this.playDrum('hat', this.nextNoteTime);
            }

            this.nextNoteTime += secondsPerBeat;
            this.beatCount++;
        }
        requestAnimationFrame(() => this.scheduler());
    }
};

// --- 2. Visual Engine ---
const VisualEngine = {
    canvas: document.getElementById('canvas'),
    ctx: null,
    width: 0,
    height: 0,
    shapes: [],
    // Miku Colors + Neon Accents
    colors: ['#39c5bb', '#e11584', '#f5f5f5', '#ffeb3b', '#00e5ff'],
    bgColor: '#1a1a1a',
    bgFlash: false,

    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.animate();
    },

    resize() {
        this.width = this.canvas.width = window.innerWidth;
        this.height = this.canvas.height = window.innerHeight;
    },

    // Trigger a visual effect
    trigger(x, y) {
        // If x,y not provided, random position
        x = x || Math.random() * this.width;
        y = y || Math.random() * this.height;

        const type = Math.floor(Math.random() * 3); // 0: Circle, 1: Square, 2: Line
        const color = this.colors[Math.floor(Math.random() * this.colors.length)];
        
        this.shapes.push({
            type: type,
            x: x, y: y,
            color: color,
            size: 10,
            alpha: 1,
            rotation: Math.random() * Math.PI,
            speed: 5 + Math.random() * 5
        });
    },

    flashBackground() {
        this.bgFlash = true;
    },

    animate() {
        // Clear Canvas
        if (this.bgFlash) {
            this.ctx.fillStyle = '#2a2a2a'; // Flash lighter background
            this.bgFlash = false;
        } else {
            this.ctx.fillStyle = this.bgColor;
        }
        this.ctx.fillRect(0, 0, this.width, this.height);

        // Draw Shapes
        for (let i = this.shapes.length - 1; i >= 0; i--) {
            const s = this.shapes[i];
            
            this.ctx.fillStyle = s.color;
            this.ctx.strokeStyle = s.color;
            this.ctx.globalAlpha = s.alpha;
            this.ctx.lineWidth = 4;

            this.ctx.save();
            this.ctx.translate(s.x, s.y);
            this.ctx.rotate(s.rotation);

            if (s.type === 0) { 
                // Solid Circle
                this.ctx.beginPath();
                this.ctx.arc(0, 0, s.size, 0, Math.PI * 2);
                this.ctx.fill();
            } else if (s.type === 1) { 
                // Hollow Square
                this.ctx.beginPath();
                this.ctx.rect(-s.size/2, -s.size/2, s.size, s.size);
                this.ctx.stroke();
            } else if (s.type === 2) { 
                // Cross Lines
                this.ctx.beginPath();
                this.ctx.moveTo(-s.size, 0); this.ctx.lineTo(s.size, 0);
                this.ctx.moveTo(0, -s.size); this.ctx.lineTo(0, s.size);
                this.ctx.stroke();
            }

            this.ctx.restore();

            // Update State
            s.size += s.speed;
            s.alpha -= 0.02;
            s.rotation += 0.05;

            // Remove faded shapes
            if (s.alpha <= 0) {
                this.shapes.splice(i, 1);
            }
        }
        
        this.ctx.globalAlpha = 1;
        requestAnimationFrame(() => this.animate());
    }
};

// --- 3. Interaction Control ---
const App = {
    started: false,

    init() {
        const overlay = document.getElementById('overlay');
        
        const start = () => {
            if (this.started) return;
            this.started = true;
            
            // Audio Context must be resumed after user gesture
            AudioEngine.init();
            AudioEngine.resume();
            VisualEngine.init();
            
            overlay.classList.add('hidden');
        };

        // Event Listeners for Start
        overlay.addEventListener('click', start);
        overlay.addEventListener('touchstart', start);
        window.addEventListener('keydown', start);

        // Main Interaction: Keyboard
        window.addEventListener('keydown', (e) => {
            if (!this.started) return;
            
            // Map keycode to scale index
            const keyIndex = e.keyCode % 10;
            
            AudioEngine.playTone(keyIndex);
            VisualEngine.trigger(); // Random position
        });

        // Main Interaction: Mouse/Touch
        const handleTouch = (e) => {
            if (!this.started) return;
            e.preventDefault();
            
            let x, y;
            if (e.type === 'touchstart') {
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else {
                x = e.clientX;
                y = e.clientY;
            }

            AudioEngine.playTone(); // Random pitch
            VisualEngine.trigger(x, y); // Specific position
        };

        window.addEventListener('mousedown', handleTouch);
        window.addEventListener('touchstart', handleTouch, {passive: false});
    }
};

// Initialize App
App.init();

</script>
</body>
</html>